<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIGGY - Expense Tracking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #b7e4f4 0%, #3abeed 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden; /* Prevent horizontal scroll */
            overflow-y: auto; /* Allow vertical scroll */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            touch-action: pan-y; /* Allow vertical touch scrolling */
        }
        .container {
            max-width: 1240px;
            margin: 0 auto;
            overflow-x: hidden; /* Prevent horizontal scroll */
            touch-action: pan-y; /* Allow vertical touch scrolling */
            width: 100%;
            box-sizing: border-box;
        }
        .header {
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border: 4px solid white;
            position: relative;
            z-index: 200; /* Above chatbot page */
        }
        .header > div:first-child {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        @media (min-width: 769px) {
            .header {
                align-items: center;
            }
            .header > div:first-child {
                flex: 0 0 auto;
            }
        }
        .header h1 {
            margin: 0;
            margin-bottom: 0;
        }
        .header h1 img {
            height: 101px;
            width: auto;
            margin: 0;
            object-fit: contain;
            aspect-ratio: auto;
            transform: scale(0.8);
            transform-origin: center;
        }
        .logout-btn {
            padding: 12px 24px;
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
            border: 3px solid white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        /* Desktop Navigation Tabs */
        .desktop-nav {
            display: none; /* Hidden by default, shown on desktop */
            gap: 10px;
            align-items: center;
            flex: 1;
            justify-content: center;
            margin: 0 20px;
        }
        .desktop-nav-btn {
            padding: 10px 20px;
            background: transparent;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .desktop-nav-btn:hover {
            background: #f0f0f0;
            border-color: #3abeed;
            color: #3abeed;
            transform: translateY(-2px);
        }
        .desktop-nav-btn.active {
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
            border-color: #ff6767;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        @media (min-width: 769px) {
            .desktop-nav {
                display: flex;
            }
            #desktopToggleContainer {
                display: flex !important;
            }
            /* On desktop, show chatbot section by default */
            #section-chatbot {
                display: block !important;
            }
            #section-chatbot .mobile-page {
                display: block !important;
            }
        }
        @media (max-width: 768px) {
            .logout-btn {
                display: none;
            }
            .desktop-nav {
                display: none !important;
            }
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            position: relative;
            background: transparent;
            border-top: 2px solid #e0e0e0;
            border-bottom: none;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px 0;
            padding-top: 5px;
            box-shadow: none;
            margin-top: 0;
            z-index: 200; /* Above chatbot page */
            height: auto;
        }
        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 5px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.75em;
            color: #999;
            transition: all 0.3s;
            font-weight: 600;
            min-width: 60px;
        }
        .mobile-nav-btn span:first-child {
            font-size: 1.8em;
        }
        .mobile-nav-btn.active {
            color: #ff6767;
        }
        .mobile-nav-btn:active {
            transform: scale(0.95);
            opacity: 0.7;
        }
        @media (min-width: 769px) {
            .mobile-nav {
                display: none !important;
            }
            .mobile-page[data-page] {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            /* Hide manual page on desktop - only show on mobile */
            .mobile-page[data-page="manual"] {
                display: none !important;
            }
            /* Desktop: Restore original chatbot layout */
            .mobile-page[data-page="chatbot"] {
                position: relative !important;
                top: auto !important;
                left: auto !important;
                right: auto !important;
                bottom: auto !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                z-index: auto !important;
                box-sizing: border-box !important;
            }
            .mobile-page[data-page="chatbot"].card {
                margin: 0 0 20px 0 !important;
                padding: 30px !important;
                border-radius: 25px !important;
                box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
                border: 4px solid white !important;
                background: white !important;
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            .mobile-page[data-page="chatbot"] .form-section {
                margin: 0 !important;
                padding: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }
            .mobile-page[data-page="chatbot"] #chatbotSection {
                height: auto !important;
                overflow: visible !important;
                flex: none !important;
            }
            .mobile-page[data-page="chatbot"] .chatbot-container {
                background: transparent !important;
                border-radius: 0 !important;
                overflow: visible !important;
                padding: 0 !important;
                margin: 20px 0 0 0 !important;
                flex: none !important;
                height: auto !important;
            }
            .mobile-page[data-page="chatbot"] #chatMessages {
                background: #b7e4f4 !important;
                border-radius: 20px !important;
                margin-bottom: 15px !important;
                padding: 15px !important;
                max-height: 400px !important;
                min-height: 200px !important;
                height: auto !important;
                flex: none !important;
            }
            .mobile-page[data-page="chatbot"] .chatbot-input-wrapper {
                position: relative !important;
                margin-top: 0 !important;
                margin-bottom: 15px !important;
                border-radius: 0 !important;
                border-top: none !important;
                background: transparent !important;
            }
        }
        @media (max-width: 768px) {
            /* Prevent body scrolling when chatbot page is active */
            body.chatbot-page-active {
                overflow: hidden !important;
                height: 100vh !important;
                height: 100dvh !important;
                position: fixed !important;
                width: 100% !important;
            }
            html.chatbot-page-active {
                overflow: hidden !important;
                height: 100vh !important;
                height: 100dvh !important;
            }
            body {
                padding-bottom: 20px;
                position: relative; /* Ensure body is positioned */
                height: auto; /* Allow body to grow with content */
                min-height: 100vh;
            }
            html {
                height: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }
            .mobile-nav {
                margin-top: 0px;
            }
            .mobile-page {
                display: none;
                position: relative;
                height: auto;
                min-height: auto;
            }
            .mobile-page.active {
                display: block;
                position: relative;
                height: auto;
                min-height: auto;
            }
            .card:last-child {
                margin-bottom: 20px; /* Extra margin for last card */
            }
            .container {
                padding-bottom: 20px; /* Extra padding at bottom of container */
            }
            /* Chatbot page - fixed viewport height, no page scrolling */
            .mobile-page[data-page="chatbot"] {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
                margin: 0;
                padding: 0;
                overflow: hidden; /* Prevent page scrolling */
                z-index: 50; /* Below header/nav */
            }
            .mobile-page[data-page="chatbot"].card {
                margin: 0;
                padding: 0;
                border-radius: 0;
                display: flex;
                flex-direction: column;
                box-shadow: none;
                border: none;
                background: transparent;
                width: 100%;
                height: 100%;
                height: 100dvh;
                overflow: hidden; /* Prevent card scrolling */
            }
            .mobile-page[data-page="chatbot"] .form-section {
                display: flex;
                flex-direction: column;
                margin: 0;
                padding: 0;
                height: 100%;
                height: 100dvh;
                overflow: hidden; /* Prevent form-section scrolling */
                /* Account for header and nav at top */
                padding-top: calc(150px + 70px + 20px); /* Header + nav + margins */
            }
            .mobile-page[data-page="chatbot"] #chatbotSection {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                overflow: hidden; /* Prevent chatbotSection scrolling */
                flex: 1;
                min-height: 0;
            }
            .mobile-page[data-page="chatbot"] #chatbotSection h2,
            .mobile-page[data-page="chatbot"] #chatbotSection p {
                display: none; /* Hide title and description on mobile */
            }
            /* Hide any logo inside chatbot card */
            .mobile-page[data-page="chatbot"] .chatbot-header-logo,
            .mobile-page[data-page="chatbot"] .chatbot-logo-container,
            .mobile-page[data-page="chatbot"] img[alt*="PIGGY"],
            .mobile-page[data-page="chatbot"] img[alt*="Logo"] {
                display: none !important;
            }
            .mobile-page[data-page="chatbot"] .chatbot-container {
                display: flex;
                flex-direction: column;
                margin-top: 0;
                margin-bottom: 0;
                margin-left: 15px;
                margin-right: 15px;
                position: relative;
                /* Blue background like other pages - this stays fixed */
                background: linear-gradient(135deg, #b7e4f4 0%, #3abeed 100%) !important;
                border-radius: 20px 20px 0 0; /* Rounded top, flat bottom */
                overflow: hidden; /* Clip to chatMessages */
                width: calc(100% - 30px); /* Match card width by subtracting horizontal margins */
                padding: 0; /* No padding - chatMessages handles its own padding */
                /* Fixed height from start - fills available space minus input wrapper */
                /* Use flex: 1 to fill remaining space in chatbotSection (after accounting for input) */
                flex: 1;
                min-height: 0; /* Allow flex shrinking */
                max-height: none; /* No max height constraint */
                /* Container starts at full size, doesn't expand */
            }
            /* Minimize toggle container on mobile */
            .mobile-page[data-page="chatbot"] #chatMessages {
                margin: 0;
                padding: 15px;
                padding-bottom: 15px; /* Padding at bottom for last message */
                overflow-y: auto; /* Only this scrolls */
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                touch-action: pan-y; /* Allow vertical scrolling */
                /* Completely transparent - background shows through from parent */
                background: transparent !important;
                background-color: transparent !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                /* Ensure messages stack from bottom */
                display: flex;
                flex-direction: column;
                /* Start scroll from bottom */
                scroll-behavior: smooth;
                width: 100%;
                /* Fixed height - fills entire container */
                height: 100%;
                min-height: 0; /* Allow flex shrinking */
                flex: 1; /* Fill available space in container */
            }
            .mobile-page[data-page="chatbot"] .chat-messages {
                display: flex;
                flex-direction: column;
                justify-content: flex-end; /* Stack messages from bottom */
                background: transparent !important;
                background-color: transparent !important;
                /* Ensure messages appear from bottom up */
                align-items: stretch;
            }
            /* Ensure messages stack from bottom up */
            .mobile-page[data-page="chatbot"] .chat-message {
                flex-shrink: 0;
                margin-top: 5px; /* Reduced space between messages */
                margin-bottom: 5px; /* Reduced bottom margin */
                /* Messages stack upward from bottom */
            }
            .mobile-page[data-page="chatbot"] .chat-message:first-child {
                margin-top: 0;
            }
            .mobile-page[data-page="chatbot"] .chat-message:last-child {
                margin-bottom: 5px; /* Reduced gap above input box */
            }
            .mobile-page[data-page="chatbot"] .chatbot-input-wrapper {
                position: relative;
                background: white;
                padding: 10px;
                border-top: 2px solid #e0e0e0;
                margin-top: 0; /* No margin - sits directly below container */
                margin-bottom: 0; /* No margin at bottom */
                border-radius: 0; /* No border radius - flat */
                display: flex;
                gap: 10px;
                width: 100%;
                box-sizing: border-box;
                flex-shrink: 0; /* Don't shrink */
                height: auto;
                min-height: 60px; /* Approximate input height */
            }
            .mobile-page[data-page="chatbot"] #chatbotResult {
                flex-shrink: 0;
            }
            .mobile-page[data-page="chatbot"] #chatbotMessage {
                flex-shrink: 0;
            }
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border: 4px solid white;
            touch-action: pan-y; /* Allow vertical touch scrolling */
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        @media (min-width: 1240px) {
            .card {
                max-width: 1240px !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
            #section-transactions,
            .mobile-page[data-page="transactions"],
            .mobile-page[data-page="transactions"].card {
                max-width: 1240px !important;
                width: 100% !important;
                margin-left: auto !important;
                margin-right: auto !important;
                box-sizing: border-box !important;
            }
            .mobile-page[data-page="stats"],
            .mobile-page[data-page="stats"].card,
            .mobile-page[data-page="chatbot"],
            .mobile-page[data-page="chatbot"].card {
                max-width: 1240px !important;
                margin-left: auto !important;
                margin-right: auto !important;
            }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background-color: #c8e6c9;
            background-image: none;
            color: #2e7d32;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            position: relative;
        }
        .stat-box::before {
            display: none;
        }
        .stat-box h3,
        .stat-box .amount {
            position: relative;
            z-index: 1;
            color: #2e7d32;
        }
        .stat-box h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
            color: #2e7d32;
        }
        .stat-box .amount {
            font-size: 2em;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #1b5e20;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-weight: 800;
            letter-spacing: -0.01em;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
            color: #333;
            box-sizing: border-box;
        }
        /* iOS fix for date and time inputs to keep them inside container */
        @media (max-width: 768px) {
            .mobile-page[data-page="manual"] {
                overflow: hidden !important;
                position: relative;
            }
            .mobile-page[data-page="manual"] .card {
                overflow: hidden !important;
                position: relative;
            }
            .mobile-page[data-page="manual"] .form-section {
                overflow: hidden !important;
                position: relative;
            }
            .mobile-page[data-page="manual"] .form-group {
                position: relative;
                overflow: hidden;
                contain: layout style;
            }
            .mobile-page[data-page="manual"] input[type="date"],
            .mobile-page[data-page="manual"] input[type="time"] {
                -webkit-appearance: none;
                appearance: none;
                position: relative;
                z-index: 1;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                will-change: transform;
                max-width: 100%;
                box-sizing: border-box;
                width: 100% !important;
            }
            .mobile-page[data-page="manual"] #transactionForm {
                position: relative;
                overflow: hidden;
            }
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3abeed;
            box-shadow: 0 0 0 3px rgba(58, 190, 237, 0.1);
        }
        .btn {
            padding: 12px 30px;
            border: 3px solid white;
            border-radius: 20px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
        }
        .btn-income {
            background: linear-gradient(135deg, #b7e4f4 0%, #3abeed 100%);
            color: white;
        }
        .btn-expense {
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
        }
        .expenses-list {
            margin-top: 30px;
            width: 100%;
            box-sizing: border-box;
        }
        .expenses-list h2 {
            color: #333;
            margin-bottom: 20px;
            font-weight: 800;
            letter-spacing: -0.01em;
        }
        .expenses-list-container {
            position: relative;
            max-height: none;
            overflow: visible;
            width: 100%;
            box-sizing: border-box;
        }
        .expenses-list-container.collapsed {
            max-height: 600px;
            overflow: hidden;
        }
        .expense-item-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 8px;
        }
        .expense-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ffb3d9;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            transition: transform 0.3s ease;
            touch-action: pan-y;
            z-index: 2;
        }
        .expense-item.income {
            background: #e8f5e9;
            border-left-color: #28a745;
        }
        .expense-item.expense {
            background: #ffebee;
            border-left-color: #dc3545;
        }
        .mobile-delete-btn {
            display: none;
        }
        .desktop-delete-btn {
            display: inline-block;
        }
        @media (max-width: 768px) {
            .expense-item-wrapper {
                overflow: hidden;
            }
            .expense-item {
                touch-action: pan-x;
                cursor: grab;
                z-index: 2;
            }
            .expense-item.swiped {
                transform: translateX(-80px);
            }
            .mobile-delete-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 80px;
                background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
                color: white;
                border: none;
                border-radius: 0 8px 8px 0;
                font-weight: 600;
                font-size: 0.9em;
                cursor: pointer;
                z-index: 1;
                padding: 0 10px;
                box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            }
            .desktop-delete-btn {
                display: none;
            }
        }
        .expense-info {
            flex: 1;
        }
        .expense-category {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .expense-description {
            color: #666;
            font-size: 0.9em;
        }
        .expense-date {
            color: #999;
            font-size: 0.85em;
        }
        .expense-amount {
            font-size: 1.3em;
            font-weight: bold;
            margin-left: 15px;
        }
        .expense-amount.positive {
            color: #3abeed;
        }
        .expense-amount.negative {
            color: #ff6767;
        }
        .month-separator {
            background: linear-gradient(135deg, #b7e4f4 0%, #3abeed 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 15px;
            margin: 20px 0 15px 0;
            font-weight: 700;
            font-size: 1.1em;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 3px solid white;
        }
        .month-separator:first-child {
            margin-top: 0;
        }
        .day-separator {
            color: #999;
            font-size: 0.9em;
            font-weight: 600;
            padding: 10px 0 5px 0;
            margin-top: 15px;
            text-transform: capitalize;
        }
        .day-separator:first-child {
            margin-top: 0;
        }
        .show-more-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.95) 50%, rgba(255, 255, 255, 1) 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
            cursor: pointer;
            pointer-events: auto;
            z-index: 10;
        }
        .show-more-overlay.hidden {
            display: none;
        }
        .show-more-text {
            color: #666;
            font-weight: 600;
            font-size: 0.95em;
            padding: 8px 20px;
            background: white;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        .show-more-text:hover {
            background: #f8f9fa;
            border-color: #3abeed;
            color: #3abeed;
        }
        .error {
            background: white;
            color: #ff6767;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: none;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .success {
            background: white;
            color: #3abeed;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: none;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* Toast/Pop-up Notification - Overlay above all */
        .toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
            color: #065f46;
            padding: 24px 32px;
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 700;
            font-size: 1.2em;
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            animation: popIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
            animation-fill-mode: forwards;
            border: 4px solid white;
            pointer-events: auto;
        }
        
        .toast-notification.error {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        }
        
        .toast-notification .toast-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }
        
        .toast-notification .toast-message {
            flex: 1;
        }
        
        @keyframes popIn {
            from {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        @media (max-width: 768px) {
            .toast-notification {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                min-width: 280px;
                max-width: 90%;
                padding: 20px 24px;
                font-size: 1.1em;
            }
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-state h3 {
            margin-bottom: 10px;
        }
        /* Chatbot Styles */
        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .suggestion-chip {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            color: #333;
        }
        .suggestion-chip:hover {
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
            border-color: #ff6767;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .chatbot-container {
            margin-top: 20px;
        }
        /* On mobile, chatbot container has fixed blue background */
        @media (max-width: 768px) {
            .mobile-page[data-page="chatbot"] .chatbot-container {
                background: #b7e4f4 !important;
            }
        }
        .chatbot-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .chatbot-input {
            flex: 1;
            padding: 12px;
            border: 3px solid #e0e0e0;
            border-radius: 20px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
            color: #333;
        }
        .chatbot-input:focus {
            outline: none;
            border-color: #3abeed;
            box-shadow: 0 0 0 3px rgba(58, 190, 237, 0.1);
        }
        .chatbot-send-btn {
            padding: 12px 24px;
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
            border: 3px solid white;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .chatbot-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        .chatbot-result {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-top: 15px;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #ff6767;
        }
        .parsed-data {
            margin-bottom: 15px;
        }
        .parsed-data h4 {
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }
        .parsed-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            color: #555;
        }
        .parsed-item:last-child {
            border-bottom: none;
        }
        .parsed-item strong {
            color: #333;
            margin-right: 10px;
        }
        .chatbot-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .chatbot-message {
            padding: 12px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: 500;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .chatbot-message.success {
            background: white;
            color: #3abeed;
        }
        .chatbot-message.error {
            background: white;
            color: #ff6767;
        }
        /* Chat Messages Styles */
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        /* On mobile, reverse order so newest messages appear at bottom */
        @media (max-width: 768px) {
            .mobile-page[data-page="chatbot"] .chat-messages {
                flex-direction: column;
                justify-content: flex-end;
            }
        }
        .chat-message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
            white-space: pre-wrap;
            background: white;
            color: #333;
            margin-top: 5px;
            margin-bottom: 5px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(10px);
            animation: slideIn 0.4s ease-out forwards;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chat-message.user {
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            background: #d4edda;
            border-color: #28a745;
        }
        .chat-message.bot {
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-message.bot.analysis {
            border-left: 5px solid #ff6767;
            background: linear-gradient(to right, rgba(255, 209, 209, 0.1) 0%, rgba(255, 103, 103, 0.1) 100%), white;
        }
        .chat-message-time {
            font-size: 0.75em;
            color: #999;
            margin-top: 4px;
        }
        /* Analysis Styles */
        .analysis-result {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-top: 15px;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #ff6767;
        }
        .analysis-content h4 {
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }
        .analysis-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 20px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .analysis-section h5 {
            margin-bottom: 10px;
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        .category-breakdown {
            margin-top: 10px;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .category-item:last-child {
            border-bottom: none;
        }
        .category-name {
            font-weight: 500;
            color: #333;
        }
        .category-amount {
            color: #666;
        }
        .category-percentage {
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }
        .toggle-btn {
            padding: 10px 20px;
            background: transparent;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .toggle-btn.active {
            background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%);
            color: white;
            border-color: #ff6767;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .toggle-btn:not(.active) {
            background: transparent;
            color: #666;
            border: 2px solid #e0e0e0;
        }
        .toggle-btn:not(.active):hover {
            background: #f0f0f0;
            border-color: #3abeed;
            color: #3abeed;
            transform: translateY(-2px);
        }
        @media (min-width: 769px) {
            .toggle-btn {
                padding: 10px 20px;
                font-size: 0.9em;
                font-weight: 600;
            }
        }
        
        /* Responsive Design - iPad (max-width: 1024px) */
        @media screen and (max-width: 1024px) {
            body {
                padding: 15px;
            }
            .container {
                max-width: 100%;
            }
            .card {
                padding: 20px;
                border-radius: 20px;
            }
            .header {
                padding: 15px;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 30px;
            }
            .header > div {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .header h1 {
                width: 100%;
                text-align: center;
                margin-bottom: 5px !important;
            }
            .header h1 img {
                height: 60px;
                margin: 0 auto;
                display: block;
                transform: scale(0.8);
                transform-origin: center;
            }
            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            .stat-box {
                padding: 12px;
                background-image: none !important;
                background-color: #c8e6c9 !important;
                color: #2e7d32 !important;
            }
            .stat-box::before {
                display: none !important;
            }
            .stat-box .amount {
                font-size: 1.3em;
                color: #1b5e20 !important;
            }
            .stat-box h3 {
                font-size: 0.8em;
                color: #2e7d32 !important;
                opacity: 0.95;
            }
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .chat-message {
                max-width: 85%;
            }
            /* Make chatbot bigger on iPad */
            #chatMessages {
                max-height: 500px !important;
                min-height: 300px !important;
            }
            .toggle-container {
                justify-content: flex-end;
            }
            .toggle-btn {
                flex: 0 0 auto !important;
                padding: 8px 12px !important;
                font-size: 0.85em !important;
                min-width: auto !important;
            }
            .chatbot-send-btn {
                padding: 12px !important;
                min-width: 50px;
                width: 50px;
                font-size: 1.5em;
                position: relative;
            }
            .chatbot-send-btn::after {
                content: '➤';
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-indent: 0;
                color: white;
                font-weight: bold;
            }
            .chatbot-send-btn {
                text-indent: -9999px;
                overflow: hidden;
                white-space: nowrap;
            }
            /* Responsive styles for dynamically generated content on iPad */
            .chat-message div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .expense-amount {
                margin-left: 0;
                align-self: flex-end;
            }
        }
        
        /* Responsive Design - Mobile (max-width: 768px) */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 20px;
            }
            .container {
                max-width: 100%;
            }
            .card {
                padding: 20px;
                border-radius: 20px;
            }
            .header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
                align-items: center;
                margin-bottom: 30px;
            }
            .header > div {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .header h1 {
                margin-bottom: 5px !important;
            }
            .header .logout-btn {
                align-self: flex-end;
                margin-top: -50px;
            }
            .header h1 img {
                height: 80px;
                transform: scale(0.8);
                transform-origin: center;
            }
            .pie-chart-container {
                height: 300px !important;
            }
            #pieChartLegend {
                font-size: 0.85em;
            }
            #pieChartLegend > div {
                flex-direction: column;
                gap: 12px;
            }
            #pieChartBtn, #barChartBtn {
                font-size: 0.85em !important;
                padding: 6px 12px !important;
            }
            body {
                padding: 10px;
            }
            .header {
                flex-direction: column;
                align-items: center;
                gap: 5px;
                padding: 8px 12px;
                margin-top: 5px;
                margin-bottom: 10px;
            }
            .header > div {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
            }
            .header h1 {
                width: 100%;
                text-align: center;
                margin-bottom: 0 !important;
            }
            .header h1 img {
                height: 50px;
                margin: 0 auto;
                display: block;
                transform: scale(0.8);
                transform-origin: center;
            }
            .logout-btn {
                display: none;
            }
            .card {
                padding: 15px;
                border-radius: 20px;
                margin-bottom: 15px;
            }
            .stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .stat-box {
                padding: 12px;
                background-image: none !important;
                background-color: #c8e6c9 !important;
                color: #2e7d32 !important;
            }
            .stat-box::before {
                display: none !important;
            }
            .stat-box h3 {
                font-size: 0.75em;
                color: #2e7d32 !important;
                opacity: 0.95;
            }
            .stat-box .amount {
                font-size: 1.4em;
                color: #1b5e20 !important;
            }
            .form-section h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .form-group {
                margin-bottom: 12px;
            }
            .form-group input,
            .form-group select {
                padding: 10px;
                font-size: 0.95em;
            }
            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }
            .toggle-container {
                justify-content: flex-end;
                flex-direction: row !important;
                gap: 8px !important;
            }
            .toggle-btn {
                flex: 0 0 auto !important;
                width: auto !important;
                padding: 6px 10px !important;
                font-size: 0.75em !important;
                min-width: auto !important;
            }
            /* Make chatbot bigger on mobile */
            #chatMessages {
                max-height: 500px !important;
                min-height: 350px !important;
                padding: 15px !important;
            }
            .chatbot-input-wrapper {
                flex-direction: row;
                gap: 10px;
            }
            .chatbot-input {
                flex: 1;
                padding: 12px;
            }
            .chatbot-send-btn {
                padding: 12px !important;
                min-width: 50px;
                width: 50px;
                font-size: 1.5em;
                position: relative;
                text-indent: -9999px;
                overflow: hidden;
                white-space: nowrap;
            }
            .chatbot-send-btn::after {
                content: '➤';
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                text-indent: 0;
                color: white;
                font-weight: bold;
            }
            .chat-messages {
                padding: 15px !important;
            }
            .chat-message {
                max-width: 90%;
                padding: 10px 14px;
                font-size: 0.9em;
            }
            .chatbot-actions {
                flex-direction: column;
                gap: 8px;
            }
            .chatbot-actions button {
                width: 100%;
            }
            /* Responsive styles for dynamically generated content */
            .chat-message button {
                width: 100% !important;
                margin-bottom: 8px;
            }
            .chat-message div[style*="display: flex"] {
                flex-direction: column !important;
            }
            .chat-message div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
            }
            .chat-message div[style*="grid-template-columns: repeat(2"] {
                grid-template-columns: 1fr !important;
            }
            .expense-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .expense-info {
                width: 100%;
            }
            .expense-amount {
                font-size: 1.2em;
                margin-left: 0;
                align-self: flex-end;
            }
            .expense-category {
                font-size: 0.95em;
            }
            .expense-description {
                font-size: 0.85em;
            }
            .expense-date {
                font-size: 0.8em;
            }
            .expenses-list h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }
        }
        
        /* Responsive Design - Small Mobile (max-width: 480px) */
        @media screen and (max-width: 480px) {
            body {
                padding: 8px;
            }
            .header h1 {
                margin-bottom: 5px !important;
            }
            .header h1 img {
                height: 45px;
                transform: scale(0.8);
                transform-origin: center;
            }
            .card {
                padding: 12px;
                border-radius: 15px;
            }
            .stat-box {
                padding: 10px;
                background-image: none !important;
                background-color: #c8e6c9 !important;
                color: #2e7d32 !important;
            }
            .stat-box::before {
                display: none !important;
            }
            .stat-box .amount {
                font-size: 1.2em;
                color: #1b5e20 !important;
            }
            .stat-box h3 {
                font-size: 0.7em;
                color: #2e7d32 !important;
                opacity: 0.95;
            }
            .form-section h2 {
                font-size: 1.2em;
            }
            #chatMessages {
                max-height: 450px !important;
                min-height: 300px !important;
            }
            .chat-message {
                max-width: 95%;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .chat-message div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            .expense-item {
                padding: 10px;
            }
            .expense-amount {
                font-size: 1.1em;
            }
            .pie-chart-container {
                height: 250px !important;
            }
            #pieChartLegend {
                font-size: 0.75em;
            }
            #pieChartLegend > div {
                flex-direction: column;
                gap: 8px;
            }
            #pieChartLegend > div > div {
                justify-content: center;
            }
            #pieChartBtn, #barChartBtn {
                font-size: 0.75em !important;
                padding: 5px 10px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <img src="/static/logo.png" alt="PIGGY Logo" style="height: 101px; width: auto; margin-bottom: 0;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span style="display: none; background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2.5em; font-weight: 700;">PIGGY</span>
            </h1>
                <!-- Mobile Navigation (positioned under logo in header, only visible on mobile) -->
                <div class="mobile-nav" id="mobileNav" style="display: none;">
                    <button class="mobile-nav-btn active" onclick="showMobilePage('stats')" data-page="stats">
                        <span style="font-size: 1.5em;">📊</span>
                        <span>Stats</span>
                    </button>
                    <button class="mobile-nav-btn" onclick="showMobilePage('chatbot')" data-page="chatbot">
                        <span style="font-size: 1.5em;">🤖</span>
                        <span>Chatbot</span>
                    </button>
                    <button class="mobile-nav-btn" onclick="showMobilePage('manual')" data-page="manual">
                        <span style="font-size: 1.5em;">📝</span>
                        <span>Manual</span>
                    </button>
                    <button class="mobile-nav-btn" onclick="showMobilePage('transactions')" data-page="transactions">
                        <span style="font-size: 1.5em;">📋</span>
                        <span>Transactions</span>
                    </button>
                </div>
            </div>
            
            <!-- Desktop Navigation Tabs (only visible on desktop, between logo and logout) -->
            <div class="desktop-nav" id="desktopNav">
                <button class="desktop-nav-btn active" onclick="scrollToSection('stats')" data-section="stats">📊 Stats</button>
                <button class="desktop-nav-btn" onclick="scrollToChatbotManual('chatbot')" data-section="chatbot">🤖 Chatbot</button>
                <button class="desktop-nav-btn" onclick="scrollToChatbotManual('manual')" data-section="manual">📝 Manual</button>
                <button class="desktop-nav-btn" onclick="scrollToSection('transactions')" data-section="transactions">📋 Transactions</button>
            </div>
            
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div id="error" class="error"></div>
        <div id="success" class="success"></div>

        <!-- Statistics and Pie Chart -->
        <div class="card mobile-page active" data-page="stats" id="section-stats">
            <div class="stats" id="stats">
                <div class="stat-box">
                    <h3>Total Income</h3>
                    <div class="amount" id="totalIncome">0.00</div>
                </div>
                <div class="stat-box">
                    <h3>Total Expense</h3>
                    <div class="amount" id="totalExpense">0.00</div>
                </div>
                <div class="stat-box">
                    <h3>Balance</h3>
                    <div class="amount" id="balance">0.00</div>
                </div>
            </div>
            <div class="form-section" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">📊 Spending by Category (This Month)</h2>
                    <div style="display: flex; gap: 5px; background: #f0f0f0; padding: 4px; border-radius: 20px;">
                        <button id="pieChartBtn" onclick="switchChartType('pie')" style="padding: 8px 16px; border: none; border-radius: 16px; background: linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%); color: white; font-weight: bold; cursor: pointer; font-size: 0.9em; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">📊 Pie</button>
                        <button id="barChartBtn" onclick="switchChartType('bar')" style="padding: 8px 16px; border: none; border-radius: 16px; background: transparent; color: #666; font-weight: bold; cursor: pointer; font-size: 0.9em; transition: all 0.3s;">📈 Bar</button>
                    </div>
                </div>
                <div class="pie-chart-container" style="position: relative; height: 400px; margin-top: 20px;">
                    <canvas id="categoryPieChart"></canvas>
                </div>
                <div id="pieChartLegend" style="margin-top: 20px; text-align: center; font-size: 0.9em; color: #666;"></div>
            </div>
        </div>

        <!-- Chatbot Page -->
        <div class="card mobile-page" data-page="chatbot" id="section-chatbot" style="display: none;">
            <div class="form-section">
                <!-- Toggle Buttons (Desktop only) -->
                <div class="toggle-container" id="desktopToggleContainer" style="display: none; justify-content: center; margin-bottom: 20px; gap: 10px;">
                    <button class="toggle-btn active" id="chatbotToggle" onclick="switchToChatbot()">🤖 Chatbot</button>
                    <button class="toggle-btn" id="formToggle" onclick="switchToForm()">📝 Manual Form</button>
                </div>
                
                <div id="chatbotSection">
                    <h2>🤖 Chatbot Assistant</h2>
                    <p style="color: #666; margin-bottom: 20px;">Type naturally to add expenses or income. Example: "bought lunch 60 baht yesterday"</p>
                    
                    <!-- Chatbot Input -->
                    <div class="chatbot-container">
                        <!-- Chat Messages Container -->
                        <div id="chatMessages" class="chat-messages" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px; padding: 15px; border-radius: 20px; min-height: 200px;">
                            <!-- Messages will be added here dynamically -->
                        </div>
                        
                        <div class="chatbot-input-wrapper">
                            <input type="text" id="chatbotInput" placeholder="Try: 'bought lunch 60 baht' or 'show me summary'..." class="chatbot-input">
                            <button onclick="processChatbotInput()" class="chatbot-send-btn">Send</button>
                        </div>
                        
                        <!-- Parsed Result Display -->
                        <div id="chatbotResult" class="chatbot-result" style="display: none;">
                            <div class="parsed-data">
                                <h4>Parsed Information:</h4>
                                <div class="parsed-item"><strong>Type:</strong> <span id="parsedType"></span></div>
                                <div class="parsed-item"><strong>Amount:</strong> <span id="parsedAmount"></span> ฿</div>
                                <div class="parsed-item"><strong>Category:</strong> <span id="parsedCategory"></span></div>
                                <div class="parsed-item"><strong>Date:</strong> <span id="parsedDate"></span></div>
                                <div class="parsed-item"><strong>Note:</strong> <span id="parsedNote"></span></div>
                            </div>
                            <div class="chatbot-actions">
                                <button onclick="confirmChatbotTransaction()" class="btn btn-primary">Confirm & Add</button>
                                <button onclick="cancelChatbotTransaction(); addChatMessage('❌ Transaction cancelled.', 'bot');" class="btn" style="background: #ccc; color: #333;">Cancel</button>
                            </div>
                        </div>
                        
                        <!-- Success/Error Messages -->
                        <div id="chatbotMessage" class="chatbot-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Manual Form (Desktop only, toggleable) -->
                <div id="manualFormSection" style="display: none;">
                    <h2>📝 Add Transaction</h2>
                    <form id="transactionFormDesktop">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="typeDesktop">Type</label>
                                <select id="typeDesktop" name="type" required>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="categoryDesktop">Category</label>
                                <select id="categoryDesktop" name="category" required>
                                    <option value="food">Food</option>
                                    <option value="transport">Transport</option>
                                    <option value="shopping">Shopping</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="bills">Bills</option>
                                    <option value="health">Health</option>
                                    <option value="education">Education</option>
                                    <option value="salary">Salary</option>
                                    <option value="bonus">Bonus</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="amountDesktop">Amount (฿)</label>
                                <input type="number" id="amountDesktop" name="amount" step="0.01" min="0" required placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="dateDesktop">Date</label>
                                <input type="date" id="dateDesktop" name="date" required>
                            </div>
                            <div class="form-group">
                                <label for="timeDesktop">Time</label>
                                <input type="time" id="timeDesktop" name="time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="descriptionDesktop">Description</label>
                            <input type="text" id="descriptionDesktop" name="description" placeholder="Describe this transaction...">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-income" id="submitIncomeDesktop" style="display: none;">Add Income</button>
                            <button type="submit" class="btn btn-expense" id="submitExpenseDesktop">Add Expense</button>
                        </div>
                    </form>
                </div>
                </div>
            </div>
        </div>

        <!-- Manual Form Page (Mobile only) -->
        <div class="card mobile-page" data-page="manual" id="section-manual" style="display: none;">
            <div class="form-section">
                <h2>📝 Add Transaction</h2>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">Type</label>
                            <select id="type" name="type" required>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category" required>
                                <option value="food">Food</option>
                                <option value="transport">Transport</option>
                                <option value="shopping">Shopping</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="bills">Bills</option>
                                <option value="health">Health</option>
                                <option value="education">Education</option>
                                <option value="salary">Salary</option>
                                <option value="bonus">Bonus</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount (฿)</label>
                            <input type="number" id="amount" name="amount" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="time">Time</label>
                            <input type="time" id="time" name="time" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" name="description" placeholder="Describe this transaction...">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-income" id="submitIncome" style="display: none;">Add Income</button>
                        <button type="submit" class="btn btn-expense" id="submitExpense">Add Expense</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Expenses List -->
        <div class="card mobile-page" data-page="transactions" id="section-transactions" style="display: none;">
            <div class="expenses-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0;">📋 All Transactions</h2>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin: 0; min-width: 200px;">
                            <label for="searchTransactions" style="margin-bottom: 5px; font-size: 0.9em;">🔍 Search:</label>
                            <input type="text" id="searchTransactions" name="searchTransactions" placeholder="Search by category, description, or amount..." style="width: 100%; padding: 10px; border: 3px solid #e0e0e0; border-radius: 15px; font-size: 1em; background: white; color: #333;">
                        </div>
                        <div class="form-group" style="margin: 0; min-width: 200px;">
                            <label for="monthFilter" style="margin-bottom: 5px; font-size: 0.9em;">Filter by Month:</label>
                            <select id="monthFilter" name="monthFilter" style="width: 100%; padding: 10px; border: 3px solid #e0e0e0; border-radius: 15px; font-size: 1em; background: white; color: #333; cursor: pointer;">
                                <option value="all">All Months</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="expensesListContainer" class="expenses-list-container collapsed">
                <div id="expensesList">
                    <div class="empty-state">
                        <h3>No transactions yet</h3>
                        <p>Start adding your income/expenses now!</p>
                        </div>
                    </div>
                    <div id="showMoreOverlay" class="show-more-overlay hidden">
                        <div class="show-more-text">Show more</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if logged in
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login';
        }

        // Set default date and time to now (only if form section exists)
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        if (dateInput) {
            dateInput.valueAsDate = new Date();
        }
        if (timeInput) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeInput.value = `${hours}:${minutes}`;
        }

        // Type change handler (mobile)
        const mobileTypeInput = document.getElementById('type');
        if (mobileTypeInput) {
            mobileTypeInput.addEventListener('change', function() {
                const type = this.value;
                const submitIncome = document.getElementById('submitIncome');
                const submitExpense = document.getElementById('submitExpense');
                
                if (type === 'income') {
                    submitIncome.style.display = 'inline-block';
                    submitExpense.style.display = 'none';
                } else {
                    submitIncome.style.display = 'none';
                    submitExpense.style.display = 'inline-block';
                }
            });
        }
        
        // Form submission handler (mobile)
        const mobileForm = document.getElementById('transactionForm');
        if (mobileForm) {
            mobileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const type = document.getElementById('type').value;
                const category = document.getElementById('category').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const date = document.getElementById('date').value;
                const time = document.getElementById('time').value;
                const description = document.getElementById('description').value || '';

                // If expense, make it negative
                const finalAmount = type === 'expense' ? -Math.abs(amount) : Math.abs(amount);

                hideMessages();

                try {
                    const response = await fetch('/add_expense', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token
                        },
                        body: JSON.stringify({
                            category: category,
                            amount: finalAmount,
                            date: date,
                            time: time,
                            description: description || (type === 'income' ? 'Income' : 'Expense')
                        })
                    });

                    if (response.ok) {
                        showSuccess('Transaction added successfully!');
                        document.getElementById('transactionForm').reset();
                        const dateInput = document.getElementById('date');
                        const timeInput = document.getElementById('time');
                        if (dateInput) {
                            dateInput.valueAsDate = new Date();
                        }
                        if (timeInput) {
                            const now = new Date();
                            const hours = String(now.getHours()).padStart(2, '0');
                            const minutes = String(now.getMinutes()).padStart(2, '0');
                            timeInput.value = `${hours}:${minutes}`;
                        }
                        loadExpenses();
                    } else {
                        try {
                            const data = await safeJsonParse(response);
                            showError(data.error || 'An error occurred');
                        } catch (e) {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            showError(`Error ${response.status}: ${errorText.substring(0, 100)}`);
                        }
                    }
                } catch (error) {
                    showError('An error occurred: ' + error.message);
                }
            });
        }
        
        // Type change handler (desktop)
        document.getElementById('typeDesktop').addEventListener('change', function() {
            const type = this.value;
            const submitIncome = document.getElementById('submitIncomeDesktop');
            const submitExpense = document.getElementById('submitExpenseDesktop');
            
            if (type === 'income') {
                submitIncome.style.display = 'inline-block';
                submitExpense.style.display = 'none';
            } else {
                submitIncome.style.display = 'none';
                submitExpense.style.display = 'inline-block';
            }
        });
        
        // Form submission handler (desktop)
        document.getElementById('transactionFormDesktop').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('typeDesktop').value;
            const category = document.getElementById('categoryDesktop').value;
            const amount = parseFloat(document.getElementById('amountDesktop').value);
            const date = document.getElementById('dateDesktop').value;
            const time = document.getElementById('timeDesktop').value;
            const description = document.getElementById('descriptionDesktop').value || '';

            // If expense, make it negative
            const finalAmount = type === 'expense' ? -Math.abs(amount) : Math.abs(amount);

            hideMessages();

            try {
                const response = await fetch('/add_expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        category: category,
                        amount: finalAmount,
                        date: date,
                        time: time,
                        description: description || (type === 'income' ? 'Income' : 'Expense')
                    })
                });

                if (response.ok) {
                    showSuccess('Transaction added successfully!');
                    document.getElementById('transactionFormDesktop').reset();
                    const dateInput = document.getElementById('dateDesktop');
                    const timeInput = document.getElementById('timeDesktop');
                    if (dateInput) {
                        dateInput.valueAsDate = new Date();
                    }
                    if (timeInput) {
                        const now = new Date();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        timeInput.value = `${hours}:${minutes}`;
                    }
                    loadExpenses();
                } else {
                    try {
                        const data = await safeJsonParse(response);
                        showError(data.error || 'An error occurred');
                    } catch (e) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        showError(`Error ${response.status}: ${errorText.substring(0, 100)}`);
                    }
                }
            } catch (error) {
                showError('An error occurred: ' + error.message);
            }
        });

        // Mobile form removed - manual page was removed, using toggle in chatbot section for desktop only
        // Mobile form event listeners removed since the form no longer exists

        // Store all expenses for filtering
        let allExpenses = [];

        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0.00';
            const numStr = parseFloat(num).toFixed(2);
            const parts = numStr.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        // Load expenses
        async function loadExpenses() {
            try {
                const response = await fetch('/expenses', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });

                if (response.ok) {
                    try {
                        const expenses = await safeJsonParse(response);
                        allExpenses = expenses; // Store all expenses
                        populateMonthFilter(expenses);
                        setupMonthFilter();
                        setupSearchFilter();
                        displayExpenses(expenses);
                        calculateStats(expenses);
                    } catch (e) {
                        console.error('Error parsing expenses response:', e);
                    }
                } else {
                    try {
                        const data = await safeJsonParse(response);
                        if (data.error && data.error.includes('Invalid token')) {
                            logout();
                        }
                    } catch (e) {
                        // Not JSON, check if it's an auth error
                        if (response.status === 401) {
                            logout();
                        } else {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            console.error('Error loading expenses:', errorText.substring(0, 100));
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        // Display expenses
        function displayExpenses(expenses) {
            const list = document.getElementById('expensesList');
            const container = document.getElementById('expensesListContainer');
            const showMoreOverlay = document.getElementById('showMoreOverlay');
            
            // Get selected month filter
            const monthFilter = document.getElementById('monthFilter').value;
            
            // Get search query
            const searchInput = document.getElementById('searchTransactions');
            const searchQuery = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            // Filter expenses by month if filter is set
            let filteredExpenses = expenses;
            if (monthFilter && monthFilter !== 'all') {
                filteredExpenses = expenses.filter(expense => {
                    // Use datetime if available, otherwise use date
                    const expenseDateTime = expense.datetime ? new Date(expense.datetime.replace(' ', 'T')) : new Date(expense.date + 'T00:00:00');
                    const expenseMonth = `${expenseDateTime.getFullYear()}-${String(expenseDateTime.getMonth() + 1).padStart(2, '0')}`;
                    return expenseMonth === monthFilter;
                });
            }
            
            // Filter expenses by search query if provided
            if (searchQuery) {
                filteredExpenses = filteredExpenses.filter(expense => {
                    const category = String(expense.category || '').toLowerCase();
                    const description = String(expense.description || '').toLowerCase();
                    const amount = String(expense.amount || '');
                    return category.includes(searchQuery) || 
                           description.includes(searchQuery) || 
                           amount.includes(searchQuery);
                });
            }
            
            if (filteredExpenses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>No transactions found</h3>
                        <p>${searchQuery ? 'Try a different search term or clear the search.' : (monthFilter !== 'all' ? 'Try selecting a different month or view all transactions.' : 'Start adding your income/expenses now!')}</p>
                    </div>
                `;
                showMoreOverlay.classList.add('hidden');
                container.classList.remove('collapsed');
                return;
            }

            // Sort by datetime, newest first (latest to oldest)
            filteredExpenses.sort((a, b) => {
                // Use datetime if available, otherwise fall back to date
                const dateA = a.datetime ? new Date(a.datetime.replace(' ', 'T')) : new Date(a.date + 'T00:00:00');
                const dateB = b.datetime ? new Date(b.datetime.replace(' ', 'T')) : new Date(b.date + 'T00:00:00');
                return dateB - dateA; // Newest first
            });

            // Group expenses by month
            const expensesByMonth = {};
            filteredExpenses.forEach(expense => {
                // Use datetime if available, otherwise use date
                const expenseDateTime = expense.datetime ? new Date(expense.datetime.replace(' ', 'T')) : new Date(expense.date + 'T00:00:00');
                const monthKey = `${expenseDateTime.getFullYear()}-${String(expenseDateTime.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = expenseDateTime.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                if (!expensesByMonth[monthKey]) {
                    expensesByMonth[monthKey] = {
                        label: monthLabel,
                        expenses: []
                    };
                }
                expensesByMonth[monthKey].expenses.push(expense);
            });

            // Sort months (newest first)
            const sortedMonths = Object.keys(expensesByMonth).sort((a, b) => b.localeCompare(a));

            // Build HTML with month and day separators
            let html = '';
            let transactionCount = 0;
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            sortedMonths.forEach(monthKey => {
                const monthData = expensesByMonth[monthKey];
                html += `<div class="month-separator">${monthData.label}</div>`;
                
                // Sort expenses within month by datetime (newest first)
                monthData.expenses.sort((a, b) => {
                    const dateA = a.datetime ? new Date(a.datetime.replace(' ', 'T')) : new Date(a.date + 'T00:00:00');
                    const dateB = b.datetime ? new Date(b.datetime.replace(' ', 'T')) : new Date(b.date + 'T00:00:00');
                    return dateB - dateA;
                });
                
                // Group expenses by day within the month
                const expensesByDay = {};
                monthData.expenses.forEach(expense => {
                    let expenseDateTime;
                    if (expense.datetime) {
                        expenseDateTime = new Date(expense.datetime.replace(' ', 'T'));
                    } else if (expense.time) {
                        expenseDateTime = new Date(expense.date + 'T' + expense.time);
                    } else {
                        expenseDateTime = new Date(expense.date + 'T00:00:00');
                    }
                    
                    // Create day key (YYYY-MM-DD)
                    const dayKey = expenseDateTime.toISOString().split('T')[0];
                    const dayName = dayNames[expenseDateTime.getDay()];
                    
                    if (!expensesByDay[dayKey]) {
                        expensesByDay[dayKey] = {
                            dayName: dayName,
                            expenses: []
                        };
                    }
                    expensesByDay[dayKey].expenses.push(expense);
                });
                
                // Sort days (newest first)
                const sortedDays = Object.keys(expensesByDay).sort((a, b) => b.localeCompare(a));
                
                // Display each day's transactions
                sortedDays.forEach(dayKey => {
                    const dayData = expensesByDay[dayKey];
                    html += `<div class="day-separator">${dayData.dayName}</div>`;
                    
                    dayData.expenses.forEach(expense => {
                        transactionCount++;
                const amount = parseFloat(expense.amount);
                const isIncome = amount >= 0;
                const typeClass = isIncome ? 'income' : 'expense';
                const amountClass = isIncome ? 'positive' : 'negative';
                        const absAmount = Math.abs(amount);
                        const formattedAmount = formatNumber(absAmount);
                        const amountDisplay = isIncome ? `+${formattedAmount}` : `-${formattedAmount}`;

                const categoryNames = {
                    'food': 'Food',
                    'transport': 'Transport',
                    'shopping': 'Shopping',
                    'entertainment': 'Entertainment',
                    'bills': 'Bills',
                    'health': 'Health',
                    'education': 'Education',
                    'salary': 'Salary',
                    'bonus': 'Bonus',
                    'other': 'Other'
                };

                        // Format date and time for display
                        let dateTimeDisplay = expense.date;
                        if (expense.datetime) {
                            const dt = new Date(expense.datetime.replace(' ', 'T'));
                            const timeStr = dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                            dateTimeDisplay = `${expense.date} ${timeStr}`;
                        } else if (expense.time) {
                            dateTimeDisplay = `${expense.date} ${expense.time.substring(0, 5)}`;
                        }

                        html += `
                            <div class="expense-item-wrapper" data-expense-id="${expense.id || ''}">
                                <div class="expense-item ${typeClass}" data-transaction-index="${transactionCount}" data-expense-id="${expense.id || ''}">
                                    <div class="expense-info">
                                        <div class="expense-category">${categoryNames[expense.category] || expense.category}</div>
                                        <div class="expense-description">${expense.description || '-'}</div>
                                        <div class="expense-date">${dateTimeDisplay}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div class="expense-amount ${amountClass}">${amountDisplay} ฿</div>
                                        <button onclick="deleteTransaction('${expense.id || ''}', this)" class="delete-btn desktop-delete-btn" title="Delete transaction" style="background: transparent; border: none; cursor: pointer; padding: 4px 8px; border-radius: 6px; color: #ff6767; font-size: 1.2em; transition: all 0.3s; opacity: 0.7;" onmouseover="this.style.opacity='1'; this.style.background='#ffe0e0';" onmouseout="this.style.opacity='0.7'; this.style.background='transparent';">
                                            🗑️
                                        </button>
                                    </div>
                                </div>
                                <button onclick="deleteTransaction('${expense.id || ''}', this)" class="delete-btn mobile-delete-btn" data-expense-id="${expense.id || ''}">
                                    🗑️ Delete
                                </button>
                            </div>
                `;
                    });
                });
            });

            list.innerHTML = html;
            
            // Add delete functionality
            setupDeleteButtons();
            
            // Setup swipe functionality for mobile
            setupSwipeToDelete();
            
            // Handle show more/less functionality
            const totalTransactions = transactionCount;
            if (totalTransactions > 6) {
                // Initially hide transactions beyond 6
                const allItems = list.querySelectorAll('.expense-item');
                allItems.forEach((item, index) => {
                    if (index >= 6) {
                        item.style.display = 'none';
                    }
                });
                
                // Show the overlay
                showMoreOverlay.classList.remove('hidden');
                container.classList.add('collapsed');
            } else {
                // Hide overlay if 6 or fewer transactions
                showMoreOverlay.classList.add('hidden');
                container.classList.remove('collapsed');
            }
        }
        
        // Delete transaction function
        async function deleteTransaction(expenseId, buttonElement) {
            if (!expenseId) {
                console.error('No expense ID provided');
                return;
            }
            
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('❌ Please log in again');
                return;
            }
            
            try {
                const response = await fetch('/delete_expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({ expense_id: expenseId })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Remove the transaction item from DOM
                    // Handle both .expense-item and .expense-item-wrapper
                    const expenseWrapper = buttonElement.closest('.expense-item-wrapper');
                    const expenseItem = buttonElement.closest('.expense-item');
                    
                    const elementToRemove = expenseWrapper || expenseItem;
                    
                    if (elementToRemove) {
                        elementToRemove.style.transition = 'opacity 0.3s, transform 0.3s';
                        elementToRemove.style.opacity = '0';
                        elementToRemove.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            elementToRemove.remove();
                            // Reload expenses to update the list
                            loadExpenses();
                        }, 300);
                    }
                } else {
                    alert('❌ ' + (data.error || 'Failed to delete transaction'));
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('❌ An error occurred while deleting the transaction');
            }
        }
        
        // Setup delete buttons (for future use if needed)
        function setupDeleteButtons() {
            // Delete buttons are already set up with onclick handlers in the HTML
            // This function can be used for additional setup if needed
        }
        
        // Setup swipe to delete functionality for mobile
        function setupSwipeToDelete() {
            if (window.innerWidth > 768) {
                return; // Only on mobile
            }
            
            const expenseWrappers = document.querySelectorAll('.expense-item-wrapper');
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let currentWrapper = null;
            
            expenseWrappers.forEach(wrapper => {
                const expenseItem = wrapper.querySelector('.expense-item');
                let touchStartX = 0;
                let touchCurrentX = 0;
                let isSwipeActive = false;
                
                // Touch events
                expenseItem.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    isSwipeActive = true;
                    // Close other swiped items
                    expenseWrappers.forEach(w => {
                        if (w !== wrapper) {
                            const item = w.querySelector('.expense-item');
                            if (item) {
                                item.classList.remove('swiped');
                            }
                        }
                    });
                }, { passive: true });
                
                expenseItem.addEventListener('touchmove', (e) => {
                    if (!isSwipeActive) return;
                    touchCurrentX = e.touches[0].clientX;
                    const diff = touchCurrentX - touchStartX;
                    
                    // Only allow swiping left (negative diff)
                    if (diff < 0 && Math.abs(diff) > 10) {
                        e.preventDefault();
                        const translateX = Math.max(diff, -80);
                        expenseItem.style.transform = `translateX(${translateX}px)`;
                    } else if (diff > 0) {
                        // Swiping right - reset
                        expenseItem.style.transform = 'translateX(0)';
                        expenseItem.classList.remove('swiped');
                    }
                }, { passive: false });
                
                expenseItem.addEventListener('touchend', (e) => {
                    if (!isSwipeActive) return;
                    isSwipeActive = false;
                    
                    const diff = touchCurrentX - touchStartX;
                    
                    if (diff < -40) {
                        // Swiped left enough - show delete button
                        expenseItem.classList.add('swiped');
                        expenseItem.style.transform = 'translateX(-80px)';
                    } else {
                        // Not enough swipe - reset
                        expenseItem.classList.remove('swiped');
                        expenseItem.style.transform = 'translateX(0)';
                    }
                }, { passive: true });
                
                // Click outside to close
                document.addEventListener('touchstart', (e) => {
                    if (!wrapper.contains(e.target)) {
                        expenseItem.classList.remove('swiped');
                        expenseItem.style.transform = 'translateX(0)';
                    }
                });
            });
        }
        
        // Show more transactions
        function showMoreTransactions() {
            const container = document.getElementById('expensesListContainer');
            const showMoreOverlay = document.getElementById('showMoreOverlay');
            const list = document.getElementById('expensesList');
            const allItems = list.querySelectorAll('.expense-item');
            
            // Show all transactions
            allItems.forEach(item => {
                item.style.display = '';
            });
            
            // Hide overlay and remove collapsed class
            showMoreOverlay.classList.add('hidden');
            container.classList.remove('collapsed');
        }
        
        // Set up show more button click handler
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mobile navigation
            initMobileNav();
            
            // Initialize chart type toggle button state
            switchChartType('pie');
            
            const showMoreOverlay = document.getElementById('showMoreOverlay');
            if (showMoreOverlay) {
                showMoreOverlay.addEventListener('click', showMoreTransactions);
            }
            
            // Show welcome message if chatbot is visible and empty
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                const chatbotSection = document.getElementById('chatbotSection');
                if (chatMessages && chatbotSection && chatbotSection.style.display !== 'none') {
                    // Check if chat is empty (no messages)
                    if (chatMessages.children.length === 0) {
                        showChatbotWelcomeMessage();
                    }
                }
            }, 500);
        });

        // Calculate statistics
        function calculateStats(expenses) {
            let totalIncome = 0;
            let totalExpense = 0;

            expenses.forEach(expense => {
                const amount = parseFloat(expense.amount);
                if (amount >= 0) {
                    totalIncome += amount;
                } else {
                    totalExpense += Math.abs(amount);
                }
            });

            const balance = totalIncome - totalExpense;

            document.getElementById('totalIncome').textContent = formatNumber(totalIncome);
            document.getElementById('totalExpense').textContent = formatNumber(totalExpense);
            document.getElementById('balance').textContent = formatNumber(balance);
            
            // Update pie chart
            updatePieChart(expenses);
        }
        
        let pieChartInstance = null;
        let currentChartType = 'pie'; // 'pie' or 'bar'
        
        // Consistent color mapping for categories
        function getCategoryColor(category) {
            const colorMap = {
                'food': '#FFB3D9',        // Pastel Pink
                'transport': '#B3E5FC',    // Pastel Blue
                'shopping': '#FFF9C4',     // Pastel Yellow
                'entertainment': '#C5E1A5', // Pastel Green
                'bills': '#E1BEE7',        // Pastel Purple
                'health': '#FFCCBC',       // Pastel Orange
                'education': '#F8BBD0',    // Pastel Rose
                'salary': '#B2DFDB',      // Pastel Teal
                'bonus': '#D1C4E9',       // Pastel Lavender
                'other': '#FFE0B2'        // Pastel Peach
            };
            return colorMap[category] || '#E0E0E0'; // Default grey
        }
        
        function switchChartType(type) {
            currentChartType = type;
            
            // Update button styles
            const pieBtn = document.getElementById('pieChartBtn');
            const barBtn = document.getElementById('barChartBtn');
            
            if (pieBtn && barBtn) {
                if (type === 'pie') {
                    pieBtn.style.background = 'linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%)';
                    pieBtn.style.color = 'white';
                    barBtn.style.background = 'transparent';
                    barBtn.style.color = '#666';
                } else {
                    barBtn.style.background = 'linear-gradient(to bottom, #ffd1d1 0%, #ff6767 100%)';
                    barBtn.style.color = 'white';
                    pieBtn.style.background = 'transparent';
                    pieBtn.style.color = '#666';
                }
            }
            
            // Re-render chart with new type
            if (allExpenses) {
                updatePieChart(allExpenses);
            }
        }
        
        function updatePieChart(expenses) {
            // Get current month
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Calculate total income for current month
            let monthlyIncome = 0;
            const categorySpending = {};
            
            expenses.forEach(expense => {
                const expenseDate = expense.datetime ? new Date(expense.datetime.replace(' ', 'T')) : new Date(expense.date + 'T00:00:00');
                const expenseMonth = expenseDate.getMonth();
                const expenseYear = expenseDate.getFullYear();
                
                // Only process current month
                if (expenseMonth === currentMonth && expenseYear === currentYear) {
                    const amount = parseFloat(expense.amount);
                    
                    if (amount >= 0) {
                        monthlyIncome += amount;
                    } else {
                        const category = expense.category || 'other';
                        if (!categorySpending[category]) {
                            categorySpending[category] = 0;
                        }
                        categorySpending[category] += Math.abs(amount);
                    }
                }
            });
            
            // If no income, don't show chart
            if (monthlyIncome === 0) {
                const canvas = document.getElementById('categoryPieChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#999';
                ctx.font = '16px Nunito';
                ctx.textAlign = 'center';
                ctx.fillText('No income data for this month', canvas.width / 2, canvas.height / 2);
                document.getElementById('pieChartLegend').textContent = '';
                return;
            }
            
            // Calculate total expenses
            const totalExpenses = Object.values(categorySpending).reduce((sum, amount) => sum + amount, 0);
            const remainingMoney = monthlyIncome - totalExpenses;
            
            // Calculate percentages and prepare data
            const categoryNames = {
                'food': 'Food',
                'transport': 'Transport',
                'shopping': 'Shopping',
                'entertainment': 'Entertainment',
                'bills': 'Bills',
                'health': 'Health',
                'education': 'Education',
                'salary': 'Salary',
                'bonus': 'Bonus',
                'other': 'Other'
            };
            
            const labels = [];
            const data = [];
            const categoryOrder = []; // Store category order to maintain color consistency
            
            // Process categories and maintain order
            for (const [category, amount] of Object.entries(categorySpending)) {
                const percentage = (amount / monthlyIncome) * 100;
                if (percentage > 0) {
                    labels.push(categoryNames[category] || category);
                    data.push(percentage);
                    categoryOrder.push(category); // Store original category for color mapping
                }
            }
            
            // Add remaining money as grey segment if there's remaining money
            if (remainingMoney > 0) {
                const remainingPercentage = (remainingMoney / monthlyIncome) * 100;
                labels.push('Remaining');
                data.push(remainingPercentage);
                categoryOrder.push('remaining'); // Special marker for remaining
            }
            
            // Destroy existing chart if it exists
            if (pieChartInstance) {
                pieChartInstance.destroy();
            }
            
            // Prepare background colors using consistent color mapping
            const backgroundColors = [];
            labels.forEach((label, index) => {
                if (label === 'Remaining') {
                    backgroundColors.push('#E0E0E0'); // Grey for remaining money
                } else {
                    // Use the stored category to get consistent color
                    const category = categoryOrder[index];
                    backgroundColors.push(getCategoryColor(category));
                }
            });
            
            // Create chart (pie or bar based on currentChartType)
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            
            const chartConfig = {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spending',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const segmentAmount = (value / 100) * monthlyIncome;
                                    return `${label}: ${value.toFixed(1)}% (${formatNumber(segmentAmount)} ฿)`;
                                }
                            }
                        }
                    }
                }
            };
            
            // Add bar chart specific options
            if (currentChartType === 'bar') {
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                };
            }
            
            pieChartInstance = new Chart(ctx, chartConfig);
            
            // Create custom legend
            let legendHtml = '<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">';
            labels.forEach((label, index) => {
                const percentage = data[index];
                const segmentAmount = (percentage / 100) * monthlyIncome;
                const color = backgroundColors[index];
                legendHtml += `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: ${color}; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
                        <span><strong>${label}</strong>: ${percentage.toFixed(1)}% (${formatNumber(segmentAmount)} ฿)</span>
                    </div>
                `;
            });
            legendHtml += '</div>';
            document.getElementById('pieChartLegend').innerHTML = legendHtml;
        }

            // Populate month filter dropdown
        function populateMonthFilter(expenses) {
            const monthFilter = document.getElementById('monthFilter');
            const existingValue = monthFilter.value;
            
            // Get unique months from expenses (only months that have transactions)
            const monthsMap = new Map();
            expenses.forEach(expense => {
                // Use datetime if available, otherwise use date
                const expenseDateTime = expense.datetime ? new Date(expense.datetime.replace(' ', 'T')) : new Date(expense.date + 'T00:00:00');
                const monthKey = `${expenseDateTime.getFullYear()}-${String(expenseDateTime.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = expenseDateTime.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Only add if not already in map (ensures uniqueness)
                if (!monthsMap.has(monthKey)) {
                    monthsMap.set(monthKey, monthLabel);
                }
            });
            
            // Sort months (newest first)
            const sortedMonths = Array.from(monthsMap.entries())
                .sort((a, b) => b[0].localeCompare(a[0]))
                .map(([key, label]) => ({ key, label }));
            
            // Clear existing options
            monthFilter.innerHTML = '';
            
            // If there are no months with transactions, show "All Months" only
            if (sortedMonths.length === 0) {
                const option = document.createElement('option');
                option.value = 'all';
                option.textContent = 'All Months';
                monthFilter.appendChild(option);
                monthFilter.value = 'all';
                return;
            }
            
            // If there's only one month, auto-select it and don't show "All Months"
            if (sortedMonths.length === 1) {
                const option = document.createElement('option');
                option.value = sortedMonths[0].key;
                option.textContent = sortedMonths[0].label;
                monthFilter.appendChild(option);
                monthFilter.value = sortedMonths[0].key;
                // Trigger change event to filter expenses
                monthFilter.dispatchEvent(new Event('change'));
                return;
            }
            
            // If there are multiple months, show "All Months" option first
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All Months';
            monthFilter.appendChild(allOption);
            
            // Add month options
            sortedMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month.key;
                option.textContent = month.label;
                monthFilter.appendChild(option);
            });
            
            // Restore previous selection if it still exists, otherwise default to "All Months"
            if (existingValue && Array.from(monthFilter.options).some(opt => opt.value === existingValue)) {
                monthFilter.value = existingValue;
            } else {
                monthFilter.value = 'all';
            }
        }

        // Set up month filter event listener
        function setupMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            if (monthFilter) {
                // Remove existing listener if any
                monthFilter.removeEventListener('change', handleMonthFilterChange);
                monthFilter.addEventListener('change', handleMonthFilterChange);
            }
        }

        function handleMonthFilterChange() {
            displayExpenses(allExpenses);
        }

        function setupSearchFilter() {
            const searchInput = document.getElementById('searchTransactions');
            if (searchInput) {
                // Remove existing listeners if any
                searchInput.removeEventListener('input', handleSearchChange);
                searchInput.removeEventListener('keyup', handleSearchKeyup);
                // Add event listeners for real-time search
                searchInput.addEventListener('input', handleSearchChange);
                searchInput.addEventListener('keyup', handleSearchKeyup);
            }
        }

        function handleSearchChange() {
            displayExpenses(allExpenses);
        }

        function handleSearchKeyup(event) {
            // Allow Enter key to trigger search
            if (event.key === 'Enter') {
                displayExpenses(allExpenses);
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('uid');
            window.location.href = '/login';
        }

        // Helper functions
        function showError(message) {
            // Remove any existing toast notifications
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new toast notification for error
            const toast = document.createElement('div');
            toast.className = 'toast-notification error';
            toast.innerHTML = `
                <span class="toast-icon">❌</span>
                <span class="toast-message">${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation completes (4 seconds total for errors)
            setTimeout(() => {
                toast.remove();
            }, 4000);
            
            // Also show in the existing error div for compatibility
            const errorDiv = document.getElementById('error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(hideMessages, 5000);
            }
        }

        function showSuccess(message) {
            // Remove any existing toast notifications
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new toast notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `
                <span class="toast-icon">✅</span>
                <span class="toast-message">${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation completes (3 seconds total)
            setTimeout(() => {
                toast.remove();
            }, 3000);
            
            // Also show in the existing success div for compatibility
            const successDiv = document.getElementById('success');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(hideMessages, 3000);
            }
        }

        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        // Load data when page loads
        loadExpenses();
        
        // Set up month filter and show more button on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupMonthFilter();
                setupSearchFilter();
                const showMoreOverlay = document.getElementById('showMoreOverlay');
                if (showMoreOverlay) {
                    showMoreOverlay.addEventListener('click', showMoreTransactions);
                }
            });
        } else {
            setupMonthFilter();
            setupSearchFilter();
            const showMoreOverlay = document.getElementById('showMoreOverlay');
            if (showMoreOverlay) {
                showMoreOverlay.addEventListener('click', showMoreTransactions);
            }
        }
        
        // Chatbot functionality
        let parsedData = null;
        
        // Helper function to safely parse JSON responses
        async function safeJsonParse(response) {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Expected JSON but got ${contentType || 'unknown'}. Response: ${text.substring(0, 100)}`);
            }
            return await response.json();
        }
        
        // Desktop: Scroll to section (smooth scroll)
        function scrollToSection(section) {
            // Only work on desktop
            if (window.innerWidth <= 768) return;
            
            const sectionElement = document.getElementById(`section-${section}`);
            if (sectionElement) {
                // Calculate offset to account for header
                const headerHeight = document.querySelector('.header').offsetHeight;
                const offset = headerHeight + 20; // Header height + some margin
                
                const elementPosition = sectionElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Update active button
                document.querySelectorAll('.desktop-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`.desktop-nav-btn[data-section="${section}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        }
        
        // Desktop: Scroll to chatbot section and toggle to manual if needed
        function scrollToChatbotManual(mode) {
            // Only work on desktop
            if (window.innerWidth <= 768) return;
            
            // Scroll to chatbot section
            const sectionElement = document.getElementById('section-chatbot');
            if (sectionElement) {
                const headerHeight = document.querySelector('.header').offsetHeight;
                const offset = headerHeight + 20;
                const elementPosition = sectionElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Toggle to the requested mode
                if (mode === 'manual') {
                    switchToForm();
                } else {
                    switchToChatbot();
                }
                
                // Update active button - only highlight the button that was clicked
                document.querySelectorAll('.desktop-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`.desktop-nav-btn[data-section="${mode}"]`);
                if (activeBtn) activeBtn.classList.add('active');
            }
        }
        
        // Toggle functions for chatbot/manual form
        function switchToChatbot() {
            if (window.innerWidth > 768) {
                document.getElementById('chatbotSection').style.display = 'block';
                document.getElementById('manualFormSection').style.display = 'none';
                document.getElementById('chatbotToggle').classList.add('active');
                document.getElementById('formToggle').classList.remove('active');
                // Show welcome message if chat is empty
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages && chatMessages.children.length === 0) {
                    showChatbotWelcomeMessage();
                }
            }
        }
        
        function switchToForm() {
            if (window.innerWidth > 768) {
                document.getElementById('chatbotSection').style.display = 'none';
                document.getElementById('manualFormSection').style.display = 'block';
                document.getElementById('chatbotToggle').classList.remove('active');
                document.getElementById('formToggle').classList.add('active');
            }
        }
        
        // Update active desktop nav button based on scroll position
        function updateActiveDesktopNav() {
            // Only work on desktop
            if (window.innerWidth <= 768) return;
            
            const sections = ['stats', 'chatbot', 'transactions'];
            const headerHeight = document.querySelector('.header').offsetHeight;
            const offset = headerHeight + 20;
            const scrollPosition = window.pageYOffset + offset;
            
            let activeSection = 'stats';
            
            sections.forEach(section => {
                const element = document.getElementById(`section-${section}`);
                if (element) {
                    const elementTop = element.offsetTop;
                    const elementBottom = elementTop + element.offsetHeight;
                    
                    if (scrollPosition >= elementTop && scrollPosition < elementBottom) {
                        activeSection = section;
                    }
                }
            });
            
            // Special handling: if in chatbot section, mark both chatbot and manual as active
            const chatbotElement = document.getElementById('section-chatbot');
            if (chatbotElement) {
                const chatbotTop = chatbotElement.offsetTop;
                const chatbotBottom = chatbotTop + chatbotElement.offsetHeight;
                if (scrollPosition >= chatbotTop && scrollPosition < chatbotBottom) {
                    activeSection = 'chatbot';
                }
            }
            
            // Update active button
            document.querySelectorAll('.desktop-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (activeSection === 'chatbot') {
                // Check which mode is actually active (chatbot or manual) and highlight only that button
                const chatbotSection = document.getElementById('chatbotSection');
                const manualFormSection = document.getElementById('manualFormSection');
                
                // Check which section is visible
                const isChatbotVisible = chatbotSection && 
                    window.getComputedStyle(chatbotSection).display !== 'none';
                const isManualVisible = manualFormSection && 
                    window.getComputedStyle(manualFormSection).display !== 'none';
                
                if (isChatbotVisible) {
                    // Chatbot mode is active
                    const chatbotBtn = document.querySelector(`.desktop-nav-btn[data-section="chatbot"]`);
                    if (chatbotBtn) chatbotBtn.classList.add('active');
                } else if (isManualVisible) {
                    // Manual mode is active
                    const manualBtn = document.querySelector(`.desktop-nav-btn[data-section="manual"]`);
                    if (manualBtn) manualBtn.classList.add('active');
                } else {
                    // Default to chatbot if neither is explicitly visible (shouldn't happen, but fallback)
                    const chatbotBtn = document.querySelector(`.desktop-nav-btn[data-section="chatbot"]`);
                    if (chatbotBtn) chatbotBtn.classList.add('active');
                }
            } else {
                const activeBtn = document.querySelector(`.desktop-nav-btn[data-section="${activeSection}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        }
        
        // Mobile page navigation
        function showMobilePage(page) {
            // Hide all pages
            document.querySelectorAll('.mobile-page').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            
            // Show selected page
            const selectedPage = document.querySelector(`.mobile-page[data-page="${page}"]`);
            if (selectedPage) {
                selectedPage.classList.add('active');
                selectedPage.style.display = 'block';
            }
            
            // Update nav buttons
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.mobile-nav-btn[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Prevent page scrolling when chatbot is active (mobile only)
            if (page === 'chatbot' && window.innerWidth <= 768) {
                document.body.classList.add('chatbot-page-active');
                document.documentElement.classList.add('chatbot-page-active');
                // Prevent any scrolling on the page itself
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.height = '100vh';
                document.body.style.height = '100dvh';
            } else {
                // Remove chatbot page classes when switching away
                document.body.classList.remove('chatbot-page-active');
                document.documentElement.classList.remove('chatbot-page-active');
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
            }
            
            // Scroll to top (only if not chatbot page)
            if (page !== 'chatbot') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // If switching to chatbot, ensure chat messages scroll to bottom and show welcome message
            if (page === 'chatbot') {
                // On mobile, explicitly ensure chatbot section is visible and manual form is hidden
                if (window.innerWidth <= 768) {
                    const chatbotSection = document.getElementById('chatbotSection');
                    const manualFormSection = document.getElementById('manualFormSection');
                    if (chatbotSection) {
                        chatbotSection.style.display = 'block';
                    }
                    if (manualFormSection) {
                        manualFormSection.style.display = 'none';
                    }
                }
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages && window.innerWidth <= 768) {
                        // Remove any inline background styles on mobile
                        chatMessages.style.background = 'transparent';
                        chatMessages.style.backgroundColor = 'transparent';
                        // Remove any height constraints that might cause expansion
                        chatMessages.style.height = '100%';
                        chatMessages.style.minHeight = '0';
                        chatMessages.style.maxHeight = 'none';
                        // Scroll to bottom immediately to show latest messages (they stack from bottom)
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        // Force scroll to bottom after a brief delay to ensure it works
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 200);
                    }
                    // Show welcome message if chat is empty
                    if (chatMessages && chatMessages.children.length === 0) {
                        showChatbotWelcomeMessage();
                    }
                }, 100);
            }
        }
        
        // Track if mobile nav has been initialized
        let mobileNavInitialized = false;
        
        // Initialize mobile navigation on page load
        function initMobileNav(forceReset = false) {
            const mobileNav = document.getElementById('mobileNav');
            if (!mobileNav) return;
            
            if (window.innerWidth <= 768) {
                mobileNav.style.display = 'flex';
                
                // Only reset pages on first load, not on resize
                if (!mobileNavInitialized || forceReset) {
                    // Hide all pages first
                    document.querySelectorAll('.mobile-page').forEach(p => {
                        p.classList.remove('active');
                        p.style.display = 'none';
                    });
                    // Show stats page by default only on first load
                    if (!mobileNavInitialized) {
                        showMobilePage('stats');
                    }
                    mobileNavInitialized = true;
                }
                
                // Ensure chat messages background is transparent on mobile
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.style.background = 'transparent';
                    chatMessages.style.backgroundColor = 'transparent';
                }
            } else {
                mobileNav.style.display = 'none';
                // Remove chatbot page classes on desktop
                document.body.classList.remove('chatbot-page-active');
                document.documentElement.classList.remove('chatbot-page-active');
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
                // Show all pages on desktop
                document.querySelectorAll('.mobile-page').forEach(p => {
                    p.style.display = 'block';
                    p.classList.add('active');
                });
                mobileNavInitialized = false; // Reset for desktop
            }
        }
        
        // Handle window resize - but don't reset page
        window.addEventListener('resize', function() {
            initMobileNav(false); // Don't force reset on resize
        });
        
        // Update active desktop nav on scroll (desktop only)
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (window.innerWidth > 768) {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateActiveDesktopNav, 100);
            }
        });
        
        // Initial update of active desktop nav
        if (window.innerWidth > 768) {
            updateActiveDesktopNav();
            // Initialize desktop form date/time
            const dateInputDesktop = document.getElementById('dateDesktop');
            const timeInputDesktop = document.getElementById('timeDesktop');
            if (dateInputDesktop) {
                dateInputDesktop.valueAsDate = new Date();
            }
            if (timeInputDesktop) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeInputDesktop.value = `${hours}:${minutes}`;
            }
        }
        
        // Toggle functions
        
        // Allow Enter key to submit chatbot input
        function setupChatbotInput() {
            const chatbotInput = document.getElementById('chatbotInput');
            if (chatbotInput) {
                // Remove existing listeners to avoid duplicates
                chatbotInput.removeEventListener('keypress', handleEnterKey);
                chatbotInput.addEventListener('keypress', handleEnterKey);
            }
        }
        
        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                processChatbotInput();
            }
        }
        
        // Set up when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupChatbotInput);
        } else {
            setupChatbotInput();
        }
        
        // Also set up after page fully loads
        window.addEventListener('load', setupChatbotInput);
        
        // Handle mobile keyboard appearance for chatbot input
        if (window.innerWidth <= 768) {
            const chatbotInput = document.getElementById('chatbotInput');
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatbotInput && chatMessages) {
                // When input is focused, scroll to bottom to show latest messages
                chatbotInput.addEventListener('focus', function() {
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 300); // Wait for keyboard animation
                });
                
                // When input loses focus, ensure proper scroll position
                chatbotInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 300);
                });
            }
        }
        
        // Add message to chat
        // Show welcome message when chatbot is opened
        function showChatbotWelcomeMessage() {
            const welcomeText = `👋 <strong>Welcome to PIGGY Chatbot!</strong><br><br>
I'm your smart expense assistant! I can help you track expenses, income, and analyze your spending.<br><br>
Type <strong>"guide"</strong> to see all available commands and how to use them.`;
            addChatMessage(welcomeText, 'bot');
        }
        
        function addChatMessage(text, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Create content div for text (supports HTML)
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = text;
            
            // Create time div
            const timeDiv = document.createElement('div');
            timeDiv.className = 'chat-message-time';
            timeDiv.textContent = time;
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            
            // Calculate animation delay based on message count for staggered effect
            const existingMessages = chatMessages.querySelectorAll('.chat-message');
            const messageIndex = existingMessages.length;
            // Add a small delay for each new message (0.15s per message)
            const delay = messageIndex * 0.15;
            messageDiv.style.animationDelay = `${delay}s`;
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom smoothly after animation starts
            // On mobile, ensure we scroll to show the latest message at bottom
            setTimeout(() => {
                if (window.innerWidth <= 768) {
                    // For mobile: scroll to bottom (messages stack upward)
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
                }
            }, delay * 1000 + 50);
        }
        
        async function processChatbotInput() {
            const inputElement = document.getElementById('chatbotInput');
            if (!inputElement) {
                console.error('Chatbot input element not found');
                return;
            }
            
            const input = inputElement.value.trim();
            if (!input) return;
            
            // Get token
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                addChatMessage('❌ Please log in again', 'bot');
                return;
            }
            
            // Check if there's a pending transaction confirmation
            if (parsedData) {
                const lowerInput = input.toLowerCase().trim();
                
                // Check for cancellation
                if (lowerInput === 'cancel' || lowerInput === 'no' || lowerInput === 'n' || lowerInput === 'abort') {
                    // Show user message
                    addChatMessage(input, 'user');
                    inputElement.value = '';
                    
                    // Cancel the transaction
                    cancelChatbotTransaction();
                    addChatMessage('❌ Transaction cancelled.', 'bot');
                    return;
                }
                
                // Check for confirmation
                if (lowerInput === 'yes' || lowerInput === 'y' || lowerInput === 'confirm') {
                    // Show user message
                    addChatMessage(input, 'user');
                    inputElement.value = '';
                    
                    // Confirm the transaction
                    await confirmChatbotTransaction();
                    return;
                }
                
                // Check for corrections
                const corrections = handleTransactionCorrections(input, parsedData);
                if (corrections.updated) {
                    // Show user message
                    addChatMessage(input, 'user');
                    inputElement.value = '';
                    
                    // Update parsedData with corrections
                    parsedData = corrections.data;
                    
                    // Show feedback message
                    addChatMessage('✅ Updated! Here\'s the corrected transaction:', 'bot');
                    
                    // Remove old confirmation message
                    const chatMessages = document.getElementById('chatMessages');
                    const messages = chatMessages.querySelectorAll('.chat-message');
                    for (let i = messages.length - 1; i >= 0; i--) {
                        if (messages[i].classList.contains('confirmation-message')) {
                            messages[i].remove();
                            break;
                        }
                    }
                    
                    // Show updated confirmation
                    displayTransactionConfirmation(parsedData);
                    return;
                } else {
                    // If there's a pending transaction but input doesn't match corrections or yes, show hint
                    addChatMessage(input, 'user');
                    inputElement.value = '';
                    addChatMessage('💡 Type "yes" to confirm, "cancel" to cancel, or type a correction (e.g., "food", "100", "income")', 'bot');
                    return;
                }
            }
            
            // Show user message immediately
            addChatMessage(input, 'user');
            inputElement.value = '';
            
            hideChatbotMessage();
            const chatbotResult = document.getElementById('chatbotResult');
            const analysisResult = document.getElementById('analysisResult');
            if (chatbotResult) chatbotResult.style.display = 'none';
            if (analysisResult) analysisResult.style.display = 'none';
            
            try {
                const response = await fetch('/chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({ text: input })
                });
                
                // Check if response is OK
                if (!response.ok) {
                    try {
                        const data = await safeJsonParse(response);
                        addChatMessage('❌ ' + (data.error || 'An error occurred'), 'bot');
                    } catch (e) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        addChatMessage(`❌ Error ${response.status}: ${errorText.substring(0, 100)}`, 'bot');
                    }
                    return;
                }
                
                // Parse JSON response
                let data;
                try {
                    data = await safeJsonParse(response);
                } catch (e) {
                    addChatMessage('❌ Server returned invalid response format: ' + e.message, 'bot');
                    return;
                }
                
                if (data.error) {
                    addChatMessage('❌ ' + data.error, 'bot');
                    return;
                }
                
                // Check if it's a conversational response
                if (data.action === 'conversation') {
                    addChatMessage(data.message || 'Hello! How can I help you?', 'bot');
                    return;
                }
                
                // Check if it's a category addition
                if (data.action === 'category_added') {
                    addChatMessage(data.message || `Category '${data.category}' added successfully!`, 'bot');
                    // Reload categories in the form
                    loadCategories();
                    return;
                }
                
                // Check if it's an analysis request - show analysis as chat message
                if (data.action === 'analysis') {
                    const analysisText = formatAnalysisAsText(data.analysis);
                    addChatMessage(analysisText, 'bot analysis');
                    parsedData = null; // Clear parsed data for analysis - don't add to database
                    return;
                }
                
                // Only show "confirm add" for transaction data (not analysis)
                // Check if this is actually transaction data (has type, amount, etc.)
                if (!data.type || !data.amount || data.amount === 0) {
                    addChatMessage('Could not parse transaction. Please try again with more details (e.g., "bought lunch 60 baht")', 'bot');
                    return;
                }
                
                // Store parsed data for transaction
                parsedData = data;
                
                // Display transaction confirmation as chat message
                displayTransactionConfirmation(data);
                
            } catch (error) {
                addChatMessage('❌ An error occurred: ' + error.message, 'bot');
            }
        }
        
        // Handle transaction corrections from user input
        function handleTransactionCorrections(input, data) {
            const lowerInput = input.toLowerCase().trim();
            let updated = false;
            const updatedData = { ...data };
            
            // Category corrections
            const categories = {
                'food': 'food', 'lunch': 'food', 'dinner': 'food', 'breakfast': 'food', 'meal': 'food',
                'transport': 'transport', 'taxi': 'transport', 'bus': 'transport', 'train': 'transport', 'uber': 'transport',
                'shopping': 'shopping', 'buy': 'shopping', 'purchase': 'shopping',
                'entertainment': 'entertainment', 'movie': 'entertainment', 'game': 'entertainment', 'fun': 'entertainment',
                'bills': 'bills', 'bill': 'bills', 'utility': 'bills',
                'health': 'health', 'medical': 'health', 'doctor': 'health', 'medicine': 'health',
                'education': 'education', 'school': 'education', 'course': 'education', 'book': 'education',
                'salary': 'salary', 'pay': 'salary', 'wage': 'salary',
                'bonus': 'bonus', 'reward': 'bonus',
                'other': 'other'
            };
            
            for (const [keyword, category] of Object.entries(categories)) {
                if (lowerInput.includes(keyword) && updatedData.category !== category) {
                    updatedData.category = category;
                    updated = true;
                    break;
                }
            }
            
            // Amount corrections - look for numbers
            const amountMatch = input.match(/(\d+(?:\.\d+)?)/);
            if (amountMatch) {
                const newAmount = parseFloat(amountMatch[1]);
                if (!isNaN(newAmount) && Math.abs(newAmount - Math.abs(updatedData.amount || 0)) > 0.01) {
                    const isExpense = updatedData.type === 'expense';
                    updatedData.amount = isExpense ? -newAmount : newAmount;
                    updated = true;
                }
            }
            
            // Type corrections
            if (lowerInput.includes('income') || lowerInput.includes('earn') || lowerInput.includes('receive')) {
                if (updatedData.type !== 'income') {
                    updatedData.type = 'income';
                    updatedData.amount = Math.abs(updatedData.amount || 0);
                    updated = true;
                }
            } else if (lowerInput.includes('expense') || lowerInput.includes('spend') || lowerInput.includes('paid')) {
                if (updatedData.type !== 'expense') {
                    updatedData.type = 'expense';
                    updatedData.amount = -Math.abs(updatedData.amount || 0);
                    updated = true;
                }
            }
            
            // Note/description corrections - if input doesn't match any pattern above, treat as note
            if (!updated && input.length > 3 && !lowerInput.match(/^\d+$/)) {
                updatedData.note = input;
                updated = true;
            }
            
            return { updated, data: updatedData };
        }
        
        async function confirmChatbotTransaction() {
            // Use parsedData directly (already updated with corrections if any)
            const transactionData = parsedData;
            
            if (!transactionData) return;
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                addChatMessage('❌ Please log in again', 'bot');
                return;
            }
            
            const type = transactionData.type;
            const category = transactionData.category;
            const amount = Math.abs(transactionData.amount);
            const date = transactionData.date;
            const time = transactionData.time || new Date().toTimeString().substring(0, 8);
            const description = transactionData.note || '';
            
            // If expense, make it negative
            const finalAmount = type === 'expense' ? -Math.abs(amount) : Math.abs(amount);
            
            try {
                const response = await fetch('/add_expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({
                        category: category,
                        amount: finalAmount,
                        date: date,
                        time: time,
                        description: description
                    })
                });
                
                if (response.ok) {
                    // Remove the confirmation message
                    const chatMessages = document.getElementById('chatMessages');
                    const messages = chatMessages.querySelectorAll('.chat-message');
                    for (let i = messages.length - 1; i >= 0; i--) {
                        if (messages[i].classList.contains('confirmation-message')) {
                            messages[i].remove();
                            break;
                        }
                    }
                    addChatMessage('✅ Transaction added successfully!', 'bot');
                    parsedData = null;
                    loadExpenses();
                } else {
                    try {
                        const data = await safeJsonParse(response);
                        addChatMessage('❌ ' + (data.error || 'An error occurred'), 'bot');
                    } catch (e) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        addChatMessage(`❌ Error ${response.status}: ${errorText.substring(0, 100)}`, 'bot');
                    }
                }
            } catch (error) {
                addChatMessage('❌ An error occurred: ' + error.message, 'bot');
            }
        }
        
        // Display transaction confirmation as text message
        function displayTransactionConfirmation(data) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bot confirmation-message';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Get formatted values
            let typeText = 'N/A';
            if (data.type && typeof data.type === 'string' && data.type.length > 0) {
                typeText = data.type.charAt(0).toUpperCase() + data.type.slice(1);
            }
            
            let categoryText = 'N/A';
            if (data.category && typeof data.category === 'string' && data.category.length > 0) {
                categoryText = data.category.charAt(0).toUpperCase() + data.category.slice(1);
            }
            
            const amountText = formatNumber(Math.abs(data.amount || 0));
            const dateText = data.date || new Date().toISOString().split('T')[0];
            const timeText = data.time || new Date().toTimeString().substring(0, 8);
            const noteText = data.note || '-';
            
            // Format time for display (HH:MM:SS -> HH:MM)
            const displayTime = timeText.substring(0, 5);
            
            // Format date for display
            const dateObj = new Date(dateText);
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            const typeIcon = typeText.toLowerCase() === 'income' ? '💰' : '💸';
            
            // Create simple text confirmation message
            const confirmationText = `${typeIcon} <strong>Transaction Details:</strong><br>
Type: ${typeText}<br>
Amount: ${amountText} ฿<br>
Category: ${categoryText}<br>
Date: ${formattedDate}<br>
Time: ${displayTime}<br>
Note: ${noteText}<br><br>
<em>Type "yes" to confirm, "cancel" to cancel, or type corrections (e.g., "food" to change category, "100" to change amount)</em>`;
            
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = confirmationText;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'chat-message-time';
            timeDiv.textContent = time;
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            
            // Calculate animation delay based on message count for staggered effect
            const existingMessages = chatMessages.querySelectorAll('.chat-message');
            const messageIndex = existingMessages.length;
            const delay = messageIndex * 0.15;
            messageDiv.style.animationDelay = `${delay}s`;
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom smoothly after animation starts
            setTimeout(() => {
                if (window.innerWidth <= 768) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, delay * 1000 + 50);
        }
        
        function cancelChatbotTransaction() {
            // Remove the confirmation message
            const chatMessages = document.getElementById('chatMessages');
            const messages = chatMessages.querySelectorAll('.chat-message');
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].classList.contains('confirmation-message')) {
                    messages[i].remove();
                    break;
                }
            }
            parsedData = null;
        }
        
        // Alias for backward compatibility (in case it's called from HTML)
        function cancelChatbotResult() {
            cancelChatbotTransaction();
        }
        
        // Format analysis as conversational text
        function formatAnalysisAsText(analysis) {
            if (analysis.error) {
                return analysis.error;
            }
            
            let text = '';
            
            // Overall spending - conversational
            text += `You have spent <strong>${formatNumber(analysis.total_spent)} ฿</strong> in total.\n\n`;
            text += `Your total income is <strong>${formatNumber(analysis.total_income)} ฿</strong>.\n`;
            text += `Your current balance is <strong>${formatNumber(analysis.balance)} ฿</strong>.\n\n`;
            
            // Category breakdown
            if (Object.keys(analysis.categories).length > 0) {
                text += `Here's how you spent by category:\n`;
                const sortedCategories = Object.entries(analysis.categories)
                    .sort((a, b) => b[1] - a[1]);
                
                sortedCategories.forEach(([category, amount]) => {
                    const percentage = analysis.percentages[category] || 0;
                    let categoryName = 'Unknown';
                    if (category && typeof category === 'string' && category.length > 0) {
                        categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                    } else {
                        categoryName = String(category || 'Unknown');
                    }
                    text += `   • ${categoryName}: ${formatNumber(amount)} ฿ (${percentage.toFixed(1)}%)\n`;
                });
                text += '\n';
            }
            
            // Most spent category
            if (analysis.most_spent_category && analysis.most_spent_category.name) {
                let categoryName = 'Unknown';
                if (analysis.most_spent_category.name && typeof analysis.most_spent_category.name === 'string' && analysis.most_spent_category.name.length > 0) {
                    categoryName = analysis.most_spent_category.name.charAt(0).toUpperCase() + analysis.most_spent_category.name.slice(1);
                } else {
                    categoryName = String(analysis.most_spent_category.name || 'Unknown');
                }
                text += `You spent the most on <strong>${categoryName}</strong> with ${formatNumber(analysis.most_spent_category.amount || 0)} ฿ (${(analysis.most_spent_category.percentage || 0).toFixed(1)}% of your total spending).\n\n`;
            }
            
            // Suggestions
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                text += `💡 <strong>Recommendations:</strong>\n`;
                analysis.suggestions.forEach(suggestion => {
                    text += `   • ${suggestion.message}\n`;
                });
                text += '\n';
            }
            
            // Monthly budget
            if (analysis.monthly_stats) {
                const stats = analysis.monthly_stats;
                text += `📊 <strong>Monthly Insights:</strong>\n`;
                text += `   • Your average daily spending is ${formatNumber(stats.avg_daily_spending)} ฿.\n`;
                if (stats.max_daily_spending !== null && stats.max_daily_spending !== undefined && stats.max_daily_spending > 0) {
                    text += `   • To stay within budget, you can spend up to ${formatNumber(stats.max_daily_spending)} ฿ per day for the rest of the month.\n`;
                }
                if (stats.projected_end_balance !== null && stats.projected_end_balance !== undefined) {
                    text += `   • Based on your current spending rate, you'll have ${formatNumber(stats.projected_end_balance)} ฿ at the end of the month.\n`;
                }
            }
            
            // Convert newlines to <br> for HTML display
            return text.replace(/\n/g, '<br>');
        }
        
        function showChatbotMessage(message, type) {
            const messageDiv = document.getElementById('chatbotMessage');
            messageDiv.textContent = message;
            messageDiv.className = 'chatbot-message ' + type;
            messageDiv.style.display = 'block';
            setTimeout(hideChatbotMessage, 5000);
        }
        
        function hideChatbotMessage() {
            document.getElementById('chatbotMessage').style.display = 'none';
        }
        
        async function loadCategories() {
            try {
                const response = await fetch('/categories', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });
                
                if (response.ok) {
                    try {
                        const data = await safeJsonParse(response);
                        const categorySelect = document.getElementById('category');
                        if (!categorySelect) return;
                        
                        const currentValue = categorySelect.value;
                        
                        // Clear existing options except default ones
                        categorySelect.innerHTML = '';
                        
                        // Add categories
                        if (data.categories && Array.isArray(data.categories)) {
                            data.categories.forEach(cat => {
                                const option = document.createElement('option');
                                option.value = cat;
                                if (cat && typeof cat === 'string' && cat.length > 0) {
                                    option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                                } else {
                                    option.textContent = String(cat || 'Unknown');
                                }
                                categorySelect.appendChild(option);
                            });
                        }
                        
                        // Restore previous selection if still available
                        if (data.categories && data.categories.includes(currentValue)) {
                            categorySelect.value = currentValue;
                        }
                    } catch (e) {
                        console.error('Error parsing categories response:', e);
                    }
                } else {
                    try {
                        const errorData = await safeJsonParse(response);
                        console.error('Error loading categories:', errorData.error);
                    } catch (e) {
                        console.error('Error loading categories:', response.status, e.message);
                    }
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Load categories on page load
        loadCategories();
        
        // Display analysis results
        function displayAnalysis(analysis) {
            if (analysis.error) {
                addChatMessage('❌ ' + analysis.error, 'bot');
                return;
            }
            
            const analysisContent = document.getElementById('analysisContent');
            let html = '<h4>📊 Expense Analysis</h4>';
            
            // Overall spending
            html += `
                <div class="analysis-section">
                    <h5>💰 Overall Spending</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Total Income</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #28a745;">${formatNumber(analysis.total_income)} ฿</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Total Spent</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: #dc3545;">${formatNumber(analysis.total_spent)} ฿</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Balance</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: ${analysis.balance >= 0 ? '#28a745' : '#dc3545'};">${formatNumber(analysis.balance)} ฿</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Category breakdown
            if (Object.keys(analysis.categories).length > 0) {
                html += `
                    <div class="analysis-section">
                        <h5>📈 Spending by Category</h5>
                        <div class="category-breakdown">
                `;
                
                // Sort categories by amount
                const sortedCategories = Object.entries(analysis.categories)
                    .sort((a, b) => b[1] - a[1]);
                
                sortedCategories.forEach(([category, amount]) => {
                    const percentage = analysis.percentages[category] || 0;
                    let categoryName = 'Unknown';
                    if (category && typeof category === 'string' && category.length > 0) {
                        categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                    } else {
                        categoryName = String(category || 'Unknown');
                    }
                    html += `
                        <div class="category-item">
                            <span class="category-name">${categoryName}</span>
                            <div style="display: flex; gap: 15px;">
                                <span class="category-amount">${formatNumber(amount || 0)} ฿</span>
                                <span class="category-percentage">${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // Most spent category
            if (analysis.most_spent_category && analysis.most_spent_category.name) {
                let categoryName = 'Unknown';
                if (analysis.most_spent_category.name && typeof analysis.most_spent_category.name === 'string' && analysis.most_spent_category.name.length > 0) {
                    categoryName = analysis.most_spent_category.name.charAt(0).toUpperCase() + analysis.most_spent_category.name.slice(1);
                } else {
                    categoryName = String(analysis.most_spent_category.name || 'Unknown');
                }
                html += `
                    <div class="analysis-section">
                        <h5>🏆 Most Spent Category</h5>
                        <div style="margin-top: 10px;">
                            <div style="font-size: 1.2em; font-weight: 600; color: #ffb3d9;">
                                ${categoryName}
                            </div>
                            <div style="color: #666; margin-top: 5px;">
                                ${formatNumber(analysis.most_spent_category.amount || 0)} ฿ (${(analysis.most_spent_category.percentage || 0).toFixed(1)}% of total)
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Suggestions
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h5>💡 Recommendations</h5>
                        <div style="margin-top: 10px;">
                `;
                analysis.suggestions.forEach(suggestion => {
                    html += `
                        <div style="padding: 10px; margin-bottom: 8px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 4px;">
                            ${suggestion.message}
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Monthly budget analysis
            if (analysis.monthly_stats) {
                const stats = analysis.monthly_stats;
                html += `
                    <div class="analysis-section">
                        <h5>📅 Monthly Budget Analysis</h5>
                        <div style="margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 0.9em;">Days Passed / Remaining</div>
                                    <div style="font-weight: 600;">${stats.days_passed} / ${stats.days_remaining} days</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.9em;">Monthly Spent</div>
                                    <div style="font-weight: 600; color: #dc3545;">${formatNumber(stats.monthly_spent)} ฿</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.9em;">Remaining Budget</div>
                                    <div style="font-weight: 600; color: ${stats.remaining_budget >= 0 ? '#28a745' : '#dc3545'};">
                                        ${formatNumber(stats.remaining_budget)} ฿
                                    </div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.9em;">Max Daily Spending</div>
                                    <div style="font-weight: 600;">${formatNumber(stats.max_daily_spending)} ฿</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.9em;">Avg Daily Spending</div>
                                    <div style="font-weight: 600;">${formatNumber(stats.avg_daily_spending)} ฿</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.9em;">Projected End Balance</div>
                                    <div style="font-weight: 600; color: ${stats.projected_end_balance >= 0 ? '#28a745' : '#dc3545'};">
                                        ${formatNumber(stats.projected_end_balance)} ฿
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            analysisContent.innerHTML = html;
            document.getElementById('analysisResult').style.display = 'block';
            document.getElementById('chatbotResult').style.display = 'none';
        }
    </script>
</body>
</html>

